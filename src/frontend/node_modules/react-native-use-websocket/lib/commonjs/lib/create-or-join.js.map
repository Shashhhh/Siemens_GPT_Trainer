{"version":3,"sources":["create-or-join.ts"],"names":["createOrJoinSocket","webSocketRef","url","setReadyState","optionsRef","setLastMessage","startRef","reconnectCount","current","share","sharedWebSockets","undefined","ReadyState","CONNECTING","WebSocket","protocols","options","readyState","subscriber","reconnect","onclose","close","e"],"mappings":";;;;;;;AACA;;AAEA;;AACA;;AACA;;AACA;;AAMO,MAAMA,kBAAkB,GAAG,CAChCC,YADgC,EAEhCC,GAFgC,EAGhCC,aAHgC,EAIhCC,UAJgC,EAKhCC,cALgC,EAMhCC,QANgC,EAOhCC,cAPgC,KAQf;AACjB,MAAIH,UAAU,CAACI,OAAX,CAAmBC,KAAvB,EAA8B;AAC5B,QAAIC,0BAAiBR,GAAjB,MAA0BS,SAA9B,EAAyC;AACvCR,MAAAA,aAAa,CAACS,sBAAWC,UAAZ,CAAb;AACAH,gCAAiBR,GAAjB,IAAwB,IAAIY,SAAJ,CACtBZ,GADsB,EAEtBE,UAAU,CAACI,OAAX,CAAmBO,SAFG,EAGtBX,UAAU,CAACI,OAAX,CAAmBQ,OAHG,CAAxB;AAKA,wDAAsBN,0BAAiBR,GAAjB,CAAtB,EAA6CA,GAA7C;AACD,KARD,MAQO;AACLC,MAAAA,aAAa,CAACO,0BAAiBR,GAAjB,EAAsBe,UAAvB,CAAb;AACD;;AAED,UAAMC,UAAU,GAAG;AACjBb,MAAAA,cADiB;AAEjBF,MAAAA,aAFiB;AAGjBC,MAAAA,UAHiB;AAIjBG,MAAAA,cAJiB;AAKjBY,MAAAA,SAAS,EAAEb;AALM,KAAnB;AAQA,0CAAcJ,GAAd,EAAmBgB,UAAnB;AACAjB,IAAAA,YAAY,CAACO,OAAb,GAAuBE,0BAAiBR,GAAjB,CAAvB;AAEA,WAAO,MAAM;AACX,+CAAiBA,GAAjB,EAAsBgB,UAAtB;;AACA,UAAI,CAAC,uCAAehB,GAAf,CAAL,EAA0B;AACxB,YAAI;AACFQ,oCAAiBR,GAAjB,EAAsBkB,OAAtB,GAAgC,MAAM,CAAE,CAAxC;;AACAV,oCAAiBR,GAAjB,EAAsBmB,KAAtB;AACD,SAHD,CAGE,OAAOC,CAAP,EAAU,CAAE;;AACd,eAAOZ,0BAAiBR,GAAjB,CAAP;AACD;AACF,KATD;AAUD,GAlCD,MAkCO;AACLC,IAAAA,aAAa,CAACS,sBAAWC,UAAZ,CAAb;AACAZ,IAAAA,YAAY,CAACO,OAAb,GAAuB,IAAIM,SAAJ,CACrBZ,GADqB,EAErBE,UAAU,CAACI,OAAX,CAAmBO,SAFE,EAGrBX,UAAU,CAACI,OAAX,CAAmBQ,OAHE,CAAvB;AAMA,WAAO,qCACLf,YAAY,CAACO,OADR,EAEL;AACEH,MAAAA,cADF;AAEEF,MAAAA;AAFF,KAFK,EAMLC,UANK,EAOLE,QAAQ,CAACE,OAPJ,EAQLD,cARK,CAAP;AAUD;AACF,CA9DM","sourcesContent":["import type { MutableRefObject } from 'react';\r\nimport { sharedWebSockets } from './globals';\r\nimport type { Options, WebSocketEventMap } from './types';\r\nimport { ReadyState } from './constants';\r\nimport { attachListeners } from './attach-listener';\r\nimport { attachSharedListeners } from './attach-shared-listeners';\r\nimport {\r\n  addSubscriber,\r\n  removeSubscriber,\r\n  hasSubscribers,\r\n} from './manage-subscribers';\r\n\r\nexport const createOrJoinSocket = (\r\n  webSocketRef: MutableRefObject<WebSocket>,\r\n  url: string,\r\n  setReadyState: (readyState: ReadyState) => void,\r\n  optionsRef: MutableRefObject<Options>,\r\n  setLastMessage: (message: WebSocketEventMap['message']) => void,\r\n  startRef: MutableRefObject<() => void>,\r\n  reconnectCount: MutableRefObject<number>\r\n): (() => void) => {\r\n  if (optionsRef.current.share) {\r\n    if (sharedWebSockets[url] === undefined) {\r\n      setReadyState(ReadyState.CONNECTING);\r\n      sharedWebSockets[url] = new WebSocket(\r\n        url,\r\n        optionsRef.current.protocols,\r\n        optionsRef.current.options\r\n      );\r\n      attachSharedListeners(sharedWebSockets[url], url);\r\n    } else {\r\n      setReadyState(sharedWebSockets[url].readyState);\r\n    }\r\n\r\n    const subscriber = {\r\n      setLastMessage,\r\n      setReadyState,\r\n      optionsRef,\r\n      reconnectCount,\r\n      reconnect: startRef,\r\n    };\r\n\r\n    addSubscriber(url, subscriber);\r\n    webSocketRef.current = sharedWebSockets[url];\r\n\r\n    return () => {\r\n      removeSubscriber(url, subscriber);\r\n      if (!hasSubscribers(url)) {\r\n        try {\r\n          sharedWebSockets[url].onclose = () => {};\r\n          sharedWebSockets[url].close();\r\n        } catch (e) {}\r\n        delete sharedWebSockets[url];\r\n      }\r\n    };\r\n  } else {\r\n    setReadyState(ReadyState.CONNECTING);\r\n    webSocketRef.current = new WebSocket(\r\n      url,\r\n      optionsRef.current.protocols,\r\n      optionsRef.current.options\r\n    );\r\n\r\n    return attachListeners(\r\n      webSocketRef.current,\r\n      {\r\n        setLastMessage,\r\n        setReadyState,\r\n      },\r\n      optionsRef,\r\n      startRef.current,\r\n      reconnectCount\r\n    );\r\n  }\r\n};\r\n"]}